# HP (formerly hittyping) - Implementation Plan

## Overview

This plan covers:
1. **Rename**: `hittyping` → `hp`
2. **CLI uniformity**: Migrate from stdlib `flag` to `spf13/pflag` (POSIX-style)
3. **v0.4.0**: `-k/--insecure` and `--http` flags
4. **v0.5.0**: Optional HTTP/3 support via build tags

---

## Phase 1: Rename and CLI Migration (v0.4.0)

### 1.1 Rename Binary

**Files to modify:**
- `justfile` - change all `hittyping` → `hp`
- `main.go` - change "HITTYPING" header → "HP"
- `CLAUDE.md` - update all usage examples
- `CHANGELOG.md` - document rename
- `go.mod` - rename module to `github.com/ac/hp`

### 1.2 Migrate to pflag

**Add dependency:**
```bash
go get github.com/spf13/pflag
```

**Flag changes in main.go:**

| Current | New Short | New Long | Description |
|---------|-----------|----------|-------------|
| `-i` | `-i` | `--interval` | Request interval |
| `-t` | `-t` | `--timeout` | Request timeout |
| `-nolegend` | `-n` | `--nolegend` | Hide legend |
| `-min` | `-m` | `--min` | Min latency baseline |
| `-green` | `-g` | `--green` | Green threshold |
| `-yellow` | `-y` | `--yellow` | Yellow threshold |
| (new) | `-k` | `--insecure` | Skip TLS verification |
| (new) | | `--http` | Use plain HTTP |

**Code transformation:**
```go
// Before (stdlib flag)
import "flag"
interval := flag.Duration("i", time.Second, "interval")

// After (pflag)
import flag "github.com/spf13/pflag"
interval := flag.DurationP("interval", "i", time.Second, "interval between requests")
```

### 1.3 New Protocol Flags

**`-k, --insecure`:**
```go
insecure := flag.BoolP("insecure", "k", false, "skip TLS certificate verification")

// Apply to transport:
Transport: &http.Transport{
    TLSClientConfig: &tls.Config{
        InsecureSkipVerify: *insecure,
    },
}
```

**`--http`:**
```go
useHTTP := flag.Bool("http", false, "use plain HTTP instead of HTTPS")

// URL handling:
if *useHTTP {
    if !strings.HasPrefix(url, "http://") {
        url = "http://" + strings.TrimPrefix(url, "https://")
    }
} else {
    // existing https:// logic
}
```

**Header indicator:**
```go
protocol := "HTTPS"
if *useHTTP {
    protocol = "HTTP"
}
fmt.Printf("%sHP %s (%s)%s\n", gray, displayURL, protocol, reset)
```

---

## Phase 2: HTTP/3 Support (v0.5.0)

### 2.1 Build Tag Architecture

**File structure:**
```
hp/
├── main.go           # Core logic, shared code
├── client.go         # Default HTTP/1.1 + HTTP/2 client
├── client_http3.go   # HTTP/3 client (build tag: http3)
└── client_stub.go    # Stub when http3 not compiled (build tag: !http3)
```

### 2.2 Client Interface

**client.go:**
```go
package main

import (
    "net/http"
    "time"
)

type ClientConfig struct {
    Timeout  time.Duration
    Insecure bool
    UseHTTP  bool
    UseHTTP3 bool
}

func newDefaultClient(cfg ClientConfig) *http.Client {
    return &http.Client{
        Timeout: cfg.Timeout,
        Transport: &http.Transport{
            TLSClientConfig: &tls.Config{
                InsecureSkipVerify: cfg.Insecure,
            },
            DisableKeepAlives: true,
        },
    }
}
```

**client_http3.go:**
```go
//go:build http3

package main

import (
    "github.com/quic-go/quic-go/http3"
)

var http3Available = true

func newHTTP3Client(cfg ClientConfig) *http.Client {
    return &http.Client{
        Timeout: cfg.Timeout,
        Transport: &http3.RoundTripper{
            TLSClientConfig: &tls.Config{
                InsecureSkipVerify: cfg.Insecure,
            },
        },
    }
}
```

**client_stub.go:**
```go
//go:build !http3

package main

import "fmt"

var http3Available = false

func newHTTP3Client(cfg ClientConfig) *http.Client {
    fmt.Println("HTTP/3 not available. Rebuild with: go build -tags http3")
    return nil
}
```

### 2.3 Flag and Client Selection

**main.go:**
```go
useHTTP3 := flag.Bool("http3", false, "use HTTP/3 (QUIC)")

// Client selection:
var client *http.Client
switch {
case *useHTTP3:
    if !http3Available {
        fmt.Fprintln(os.Stderr, "HTTP/3 not compiled in. Rebuild with -tags http3")
        os.Exit(1)
    }
    client = newHTTP3Client(cfg)
case *useHTTP:
    client = newDefaultClient(cfg) // HTTP/1.1
default:
    client = newDefaultClient(cfg) // HTTPS with HTTP/2
}
```

### 2.4 Justfile Updates

```justfile
# Default build (no HTTP/3, ~8MB)
build:
    go build -o hp .

# With HTTP/3 support (~20MB)
build-http3:
    go build -tags http3 -o hp .

# Install default
install: build
    sudo cp hp /usr/local/bin/
    sudo codesign --force --sign - /usr/local/bin/hp

# Install with HTTP/3
install-http3: build-http3
    sudo cp hp /usr/local/bin/
    sudo codesign --force --sign - /usr/local/bin/hp
```

---

## Summary: Final Flag Reference

| Short | Long | Env Var | Default | Description |
|-------|------|---------|---------|-------------|
| `-i` | `--interval` | | 1s | Request interval |
| `-t` | `--timeout` | | 5s | Request timeout |
| `-n` | `--nolegend` | | false | Hide legend line |
| `-m` | `--min` | `HP_MIN` | 0 | Min latency baseline (ms) |
| `-g` | `--green` | `HP_GREEN` | 150 | Green threshold (ms) |
| `-y` | `--yellow` | `HP_YELLOW` | 400 | Yellow threshold (ms) |
| `-k` | `--insecure` | | false | Skip TLS verification |
| | `--http` | | false | Use plain HTTP |
| | `--http3` | | false | Use HTTP/3 (QUIC) |

**Env vars also renamed:** `HITTYPING_*` → `HP_*`

---

## Implementation Order

1. **Commit 1**: Add pflag dependency, migrate existing flags
2. **Commit 2**: Add `-k/--insecure` flag
3. **Commit 3**: Add `--http` flag with protocol indicator
4. **Commit 4**: Rename binary `hittyping` → `hp`, update all refs
5. **Commit 5**: Rename env vars `HITTYPING_*` → `HP_*`
6. **Commit 6**: Update docs (CLAUDE.md, CHANGELOG.md, ROADMAP.md)
7. **Tag v0.4.0**
8. **Commit 7**: Add client interface and build tag structure
9. **Commit 8**: Implement HTTP/3 client with quic-go
10. **Commit 9**: Add build-http3 justfile recipes
11. **Commit 10**: Update docs for HTTP/3
12. **Tag v0.5.0**

---

## Verification

### v0.4.0 Testing
```bash
# Build and basic test
just build
./hp 8.8.8.8

# Flag tests
./hp -h                           # Should show all flags with short/long forms
./hp -i 500ms 8.8.8.8             # Short interval flag
./hp --interval 500ms 8.8.8.8     # Long interval flag
./hp -k https://self-signed.test  # Insecure flag
./hp --http example.com           # Plain HTTP
./hp -n -g 100 -y 200 8.8.8.8     # Combined short flags

# Env var tests
HP_GREEN=100 HP_YELLOW=200 ./hp 8.8.8.8
```

### v0.5.0 Testing
```bash
# Default build (no HTTP/3)
just build
./hp --http3 cloudflare.com       # Should error: "not compiled in"

# HTTP/3 build
just build-http3
./hp --http3 cloudflare.com       # Should work (Cloudflare supports HTTP/3)
./hp --http3 8.8.8.8              # May fail (Google DNS may not support HTTP/3)
```

---

## Files Modified

| File | Changes |
|------|---------|
| `go.mod` | Add pflag, optionally quic-go |
| `main.go` | Migrate flags, add new flags, client selection |
| `client.go` | New file: default client |
| `client_http3.go` | New file: HTTP/3 client (build tag) |
| `client_stub.go` | New file: HTTP/3 stub (build tag) |
| `justfile` | Rename binary, add http3 recipes |
| `CLAUDE.md` | Update examples |
| `CHANGELOG.md` | Document changes |
| `ROADMAP.md` | Mark items complete |
